<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Among Us - Multiplayer Game</title>
    <!-- Import Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Turn on debug logging for Firestore
        setLogLevel('debug');

        // Global variables for the app
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.db = db;
        window.auth = auth;
        
        // --- PERBAIKAN PENTING: MENGGUNAKAN ID UNIK SECARA PAKSA ---
        window.player = {
            id: crypto.randomUUID(), // Menggunakan ID unik untuk setiap sesi
            x: 50,
            y: 50,
            color: '#FFD700',
            role: null,
            isAlive: true,
            isImpostor: false
        };
        // -------------------------------------------------------------

        window.roomId = null;
        window.currentRoomRef = null;
        window.roomState = null;
        window.canvas = null;
        window.ctx = null;
        window.killCooldown = 0;
        const KILL_COOLDOWN_SECONDS = 15;

        const availableColors = ['#E57373', '#81C784', '#64B5F6', '#FFB74D', '#9575CD', '#4DB6AC', '#FF8A65', '#A1887F', '#BDBDBD', '#795548'];
        window.player.color = availableColors[Math.floor(Math.random() * availableColors.length)];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Gunakan ID unik yang sudah dibuat, bukan dari Firebase
                document.getElementById('user-id-display').textContent = 'ID Anda: ' + window.player.id;
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('lobby-screen').style.display = 'flex';
                await checkExistingRoom();
            } else {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        async function checkExistingRoom() {
            if (!window.player.id) return;
            const roomsCollectionRef = collection(window.db, `artifacts/${window.appId}/public/data/amongus_rooms`);
            const q = query(roomsCollectionRef, where('players', 'array-contains', window.player.id));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const roomDoc = querySnapshot.docs[0];
                window.roomId = roomDoc.id;
                window.currentRoomRef = doc(window.db, `artifacts/${window.appId}/public/data/amongus_rooms`, window.roomId);
                window.roomState = roomDoc.data();
                enterGame();
            }
        }

        async function createRoom() {
            try {
                document.getElementById('loading-spinner').style.display = 'block';
                const newRoomRef = doc(collection(window.db, `artifacts/${window.appId}/public/data/amongus_rooms`));
                const newRoomId = newRoomRef.id;

                const roomData = {
                    players: [{ id: window.player.id, x: 50, y: 50, color: window.player.color, isAlive: true, isImpostor: false }],
                    status: 'waiting',
                    impostorCount: 1,
                    createdAt: new Date()
                };
                await setDoc(newRoomRef, roomData);
                window.roomId = newRoomId;
                window.currentRoomRef = newRoomRef;

                document.getElementById('loading-spinner').style.display = 'none';
                enterGame();
            } catch (error) {
                console.error("Error creating room: ", error);
                document.getElementById('loading-spinner').style.display = 'none';
                showMessage("Gagal membuat room. Coba lagi.");
            }
        }

        async function joinRoom() {
            const roomIdToJoin = document.getElementById('room-id-input').value.trim();
            if (!roomIdToJoin) {
                showMessage("Mohon masukkan Room ID.");
                return;
            }

            try {
                document.getElementById('loading-spinner').style.display = 'block';
                const roomRef = doc(window.db, `artifacts/${window.appId}/public/data/amongus_rooms`, roomIdToJoin);
                const roomDoc = await getDoc(roomRef);

                if (roomDoc.exists()) {
                    const roomData = roomDoc.data();
                    if (roomData.players.length >= 10 || roomData.status !== 'waiting') {
                        showMessage("Room penuh atau sudah dimulai.");
                        document.getElementById('loading-spinner').style.display = 'none';
                        return;
                    }
                    if (roomData.players.some(p => p.id === window.player.id)) {
                        showMessage("Anda sudah berada di room ini.");
                        window.roomId = roomIdToJoin;
                        window.currentRoomRef = roomRef;
                        document.getElementById('loading-spinner').style.display = 'none';
                        enterGame();
                        return;
                    }

                    const updatedPlayers = [...roomData.players, { id: window.player.id, x: 50, y: 50, color: availableColors[roomData.players.length % availableColors.length], isAlive: true, isImpostor: false }];
                    await updateDoc(roomRef, { players: updatedPlayers });

                    window.roomId = roomIdToJoin;
                    window.currentRoomRef = roomRef;
                    document.getElementById('loading-spinner').style.display = 'none';
                    enterGame();
                } else {
                    showMessage("Room ID tidak ditemukan.");
                    document.getElementById('loading-spinner').style.display = 'none';
                }
            } catch (error) {
                console.error("Error joining room: ", error);
                document.getElementById('loading-spinner').style.display = 'none';
                showMessage("Gagal bergabung ke room. Coba lagi.");
            }
        }

        function enterGame() {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            window.canvas = document.getElementById('game-canvas');
            window.ctx = window.canvas.getContext('2d');
            window.canvas.width = window.innerWidth * 0.9;
            window.canvas.height = window.innerHeight * 0.9;
            window.player.isAlive = true;

            onSnapshot(window.currentRoomRef, (doc) => {
                if (doc.exists()) {
                    window.roomState = doc.data();
                    const myPlayerState = window.roomState.players.find(p => p.id === window.player.id);
                    if (myPlayerState) {
                        window.player.x = myPlayerState.x;
                        window.player.y = myPlayerState.y;
                        window.player.isAlive = myPlayerState.isAlive;
                        window.player.isImpostor = myPlayerState.isImpostor;
                    }
                    updateUI();
                    checkGameStatus();
                }
            }, (error) => {
                console.error("Error listening to room updates: ", error);
                showMessage("Koneksi ke room terputus.");
            });
        }
        
        function updateUI() {
            const gameInfo = document.getElementById('game-info');
            gameInfo.textContent = `Room ID: ${window.roomId}`;

            const killBtn = document.getElementById('kill-btn');
            const restartBtn = document.getElementById('restart-btn');

            if (window.roomState.status === 'playing' && window.player.isImpostor && window.player.isAlive) {
                killBtn.style.display = 'block';
                killBtn.disabled = window.killCooldown > 0;
            } else {
                killBtn.style.display = 'none';
            }

            const isCreator = window.roomState.players.length > 0 && window.roomState.players[0].id === window.player.id;
            const startBtn = document.getElementById('start-btn');
            if (isCreator && window.roomState.status === 'waiting') {
                startBtn.style.display = 'block';
            } else {
                startBtn.style.display = 'none';
            }

            if (window.roomState.status === 'over' && isCreator) {
                restartBtn.style.display = 'block';
            } else {
                restartBtn.style.display = 'none';
            }

            const roleInfo = document.getElementById('role-info');
            if (window.roomState.status === 'playing') {
                roleInfo.style.display = 'block';
                const roleText = window.player.isImpostor ? 'IMPOSTOR' : 'CREWMATE';
                const roleColor = window.player.isImpostor ? '#e74c3c' : '#2ecc71';
                roleInfo.textContent = `Peran Anda: ${roleText}`;
                roleInfo.style.color = roleColor;
            } else {
                roleInfo.style.display = 'none';
            }
        }

        function checkGameStatus() {
            if (!window.roomState || window.roomState.status !== 'playing') return;

            const alivePlayers = window.roomState.players.filter(p => p.isAlive);
            const aliveImpostors = alivePlayers.filter(p => p.isImpostor);
            const aliveCrewmates = alivePlayers.filter(p => !p.isImpostor);

            const messageBox = document.getElementById('message-box');
            let gameOutcome = '';

            if (aliveImpostors.length === 0) {
                gameOutcome = 'Crewmate Menang! Semua Impostor telah dikalahkan.';
            } else if (aliveImpostors.length >= aliveCrewmates.length) {
                gameOutcome = 'Impostor Menang! Mereka mengungguli Crewmate.';
            }

            if (gameOutcome) {
                updateDoc(window.currentRoomRef, { status: 'over', winner: gameOutcome });
                showMessage(gameOutcome);
            }
        }

        async function startGame() {
            if (window.roomState.players.length < 2) {
                showMessage('Minimal 2 pemain untuk memulai permainan.');
                return;
            }
            try {
                const impostorCount = 1;
                const shuffledPlayers = [...window.roomState.players].sort(() => 0.5 - Math.random());
                const updatedPlayers = shuffledPlayers.map((p, index) => ({
                    ...p,
                    isAlive: true,
                    isImpostor: index < impostorCount,
                    x: Math.random() * (window.canvas.width - 30) + 15,
                    y: Math.random() * (window.canvas.height - 30) + 15
                }));
                await updateDoc(window.currentRoomRef, { players: updatedPlayers, status: 'playing' });
            } catch (error) {
                console.error("Error starting game: ", error);
            }
        }

        async function killPlayer() {
            if (!window.player.isImpostor || window.killCooldown > 0) {
                showMessage("Anda bukan Impostor atau sedang cooldown.");
                return;
            }

            const target = window.roomState.players.find(p => {
                if (p.id === window.player.id || !p.isAlive) return false;
                const distance = Math.sqrt(Math.pow(p.x - window.player.x, 2) + Math.pow(p.y - window.player.y, 2));
                return distance < 50;
            });

            if (target) {
                try {
                    const updatedPlayers = window.roomState.players.map(p => {
                        if (p.id === target.id) {
                            return { ...p, isAlive: false };
                        }
                        return p;
                    });
                    await updateDoc(window.currentRoomRef, { players: updatedPlayers });

                    window.killCooldown = KILL_COOLDOWN_SECONDS;
                    const cooldownInterval = setInterval(() => {
                        window.killCooldown--;
                        if (window.killCooldown <= 0) {
                            clearInterval(cooldownInterval);
                        }
                    }, 1000);

                } catch (error) {
                    console.error("Error killing player: ", error);
                }
            } else {
                showMessage("Tidak ada Crewmate di dekat Anda.");
            }
        }

        async function restartGame() {
            try {
                const updatedPlayers = window.roomState.players.map(p => ({
                    ...p,
                    isAlive: true,
                    isImpostor: false,
                    x: Math.random() * (window.canvas.width - 30) + 15,
                    y: Math.random() * (window.canvas.height - 30) + 15
                }));
                await updateDoc(window.currentRoomRef, { players: updatedPlayers, status: 'waiting', winner: null });
            } catch (error) {
                console.error("Error restarting game: ", error);
            }
        }

        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        function drawPlayer(ctx, player) {
            const x = player.x;
            const y = player.y;
            const size = 30;
            const bodyHeight = 40;
            const backpackWidth = 20;
            const backpackHeight = 25;
            const visorWidth = 25;
            const visorHeight = 10;
            const visorColor = '#b3c3c3';
            const bodyColor = player.color;

            if (!player.isAlive) {
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(Math.PI);
                ctx.scale(1, -1);
                ctx.fillStyle = bodyColor;
                ctx.globalAlpha = 0.5;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, size * 0.8, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
                ctx.restore();
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.font = '10px Roboto Mono';
                ctx.fillText(`(DEAD) ${player.id.substring(0, 8)}`, x, y + 25);
                return;
            }

            ctx.fillStyle = bodyColor;
            ctx.beginPath();
            ctx.arc(x, y, size / 2, Math.PI, Math.PI * 2, false);
            ctx.lineTo(x - size / 2, y + bodyHeight / 2);
            ctx.arc(x, y + bodyHeight / 2, size / 2, Math.PI, 0, false);
            ctx.lineTo(x + size / 2, y);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = bodyColor;
            ctx.fillRect(x + size / 2 - backpackWidth / 2, y + 10, backpackWidth, backpackHeight);

            ctx.fillStyle = visorColor;
            ctx.beginPath();
            ctx.ellipse(x, y - 5, visorWidth / 2, visorHeight / 2, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#fff';
            ctx.textAlign = 'center';
            ctx.font = '10px Roboto Mono';
            ctx.fillText(player.id.substring(0, 8), x, y + 45);
        }

        function draw() {
            if (!window.ctx || !window.roomState) {
                requestAnimationFrame(draw);
                return;
            }

            window.ctx.clearRect(0, 0, window.canvas.width, window.canvas.height);

            window.roomState.players.forEach(p => drawPlayer(window.ctx, p));

            if (window.killCooldown > 0 && window.player.isImpostor && window.roomState.status === 'playing') {
                const killText = `Cooldown: ${window.killCooldown}s`;
                window.ctx.fillStyle = '#fff';
                window.ctx.textAlign = 'right';
                window.ctx.font = '14px Roboto Mono';
                window.ctx.fillText(killText, window.canvas.width - 20, 30);
            }
            
            if (window.roomState.status === 'over') {
                window.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                window.ctx.fillRect(0, 0, window.canvas.width, window.canvas.height);
                window.ctx.fillStyle = '#fff';
                window.ctx.textAlign = 'center';
                window.ctx.font = '40px Roboto Mono';
                window.ctx.fillText(window.roomState.winner, window.canvas.width / 2, window.canvas.height / 2);
            }

            requestAnimationFrame(draw);
        }

        window.addEventListener('keydown', async (e) => {
            if (!window.roomId || !window.currentRoomRef || !window.roomState || window.roomState.status !== 'playing' || !window.player.isAlive) return;

            let updatedX = window.player.x;
            let updatedY = window.player.y;
            const speed = 5;

            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                    updatedY -= speed;
                    break;
                case 'ArrowDown':
                case 's':
                    updatedY += speed;
                    break;
                case 'ArrowLeft':
                case 'a':
                    updatedX -= speed;
                    break;
                case 'ArrowRight':
                case 'd':
                    updatedX += speed;
                    break;
            }

            updatedX = Math.max(15, Math.min(window.canvas.width - 15, updatedX));
            updatedY = Math.max(15, Math.min(window.canvas.height - 15, updatedY));

            if (updatedX !== window.player.x || updatedY !== window.player.y) {
                try {
                    const players = window.roomState.players.map(p => {
                        if (p.id === window.player.id) {
                            return { ...p, x: updatedX, y: updatedY };
                        }
                        return p;
                    });
                    await updateDoc(window.currentRoomRef, { players: players });
                } catch (error) {
                    console.error("Error updating player position: ", error);
                }
            }
        });

        window.onload = function() {
            draw();
        };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('create-room-btn').addEventListener('click', createRoom);
            document.getElementById('join-room-btn').addEventListener('click', joinRoom);
            document.getElementById('start-btn').addEventListener('click', startGame);
            document.getElementById('kill-btn').addEventListener('click', killPlayer);
            document.getElementById('restart-btn').addEventListener('click', restartGame);
        });

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #1a1a1a;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            flex-direction: column;
        }

        .container {
            width: 90vw;
            height: 90vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #2c2c2c;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        #loading-screen, #lobby-screen, #game-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        h1 {
            font-size: 2.5rem;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
        }

        .button, .input-group input {
            padding: 15px 30px;
            font-size: 1rem;
            margin: 10px;
            border: 2px solid #fff;
            border-radius: 10px;
            background-color: #3b3b3b;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button:hover:not(:disabled) {
            background-color: #555;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }
        
        .button:disabled {
            background-color: #555;
            color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .input-group {
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 400px;
        }

        .input-group input {
            width: 100%;
            background-color: #4a4a4a;
            color: #fff;
            border: none;
            text-align: center;
        }
        
        #user-id-display {
            font-size: 0.8rem;
            margin-bottom: 20px;
            color: #aaa;
            word-break: break-all;
            padding: 5px;
            background-color: #333;
            border-radius: 5px;
            max-width: 90%;
        }

        #loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        canvas {
            background-color: #000;
            border: 2px solid #555;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #game-info {
            margin-top: 20px;
            font-size: 1rem;
            color: #ccc;
        }

        #message-box {
            position: fixed;
            top: 20px;
            background-color: rgba(255, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }
        
        #game-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }
        
        #role-info {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }
            .button, .input-group input {
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Screen -->
        <div id="loading-screen" style="display: flex;">
            <div id="loading-spinner"></div>
            <p style="margin-top: 20px;">Memuat...</p>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen">
            <h1>Selamat Datang di Among Us</h1>
            <p>Mainkan dengan teman-teman Anda! Anda dapat membuat atau bergabung dengan sebuah room.</p>
            <div id="user-id-display"></div>
            <button id="create-room-btn" class="button">Buat Room</button>
            <div class="input-group">
                <input type="text" id="room-id-input" placeholder="Masukkan Room ID">
                <button id="join-room-btn" class="button">Gabung Room</button>
            </div>
            <div id="loading-spinner" style="display: none; margin-top: 20px;"></div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen">
            <h1>Game Dimulai!</h1>
            <p>Gunakan tombol panah atau tombol WASD untuk bergerak.</p>
            <div id="game-controls">
                <p id="game-info"></p>
                <p id="role-info" style="display: none;"></p>
                <div style="display: flex;">
                    <button id="start-btn" class="button" style="display: none;">Mulai Game</button>
                    <button id="kill-btn" class="button" style="display: none;">Kill</button>
                    <button id="restart-btn" class="button" style="display: none;">Mulai Ulang</button>
                </div>
            </div>
            <canvas id="game-canvas"></canvas>
        </div>
    </div>
    
    <!-- Custom Message Box -->
    <div id="message-box"></div>
</body>
</html>
